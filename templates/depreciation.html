{% extends "base.html" %}
{% from "includes/sidebar.html" import render_sidebar %}

{% block title %}Depreciation Report - Asset Management System{% endblock %}

{% block content %}
<div class="row">
    {{ render_sidebar('depreciation') }}
    <div class="col-md-9 col-lg-10">
        <div style="margin-bottom: 32px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h1 style="font-size: 2.25rem; font-weight: 700; color: #2d3748; margin-bottom: 8px;">Depreciation Report</h1>
                    <p style="color: #718096; font-size: 1rem; margin: 0;">View asset depreciation calculations and current values</p>
                </div>
                <div>
                    <a href="{{ url_for('export_depreciation') }}" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel"></i> Export to Excel
                    </a>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Assets</h6>
                        <h3 class="mb-0">{{ total_assets }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Purchase Value</h6>
                        <h3 class="mb-0">${{ "{:,.2f}".format(total_purchase_value) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Depreciation</h6>
                        <h3 class="mb-0 text-danger">${{ "{:,.2f}".format(total_depreciation) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Current Book Value</h6>
                        <h3 class="mb-0 text-success">${{ "{:,.2f}".format(total_current_value) }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('depreciation') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                <option value="{{ cat.get('Category Name', '') }}" 
                                        {% if request.args.get('category') == cat.get('Category Name') %}selected{% endif %}>
                                    {{ cat.get('Category Name', '') }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Location</label>
                            <select class="form-select" name="location" onchange="this.form.submit()">
                                <option value="">All Locations</option>
                                {% for loc in locations %}
                                <option value="{{ loc.get('Location Name', '') }}" 
                                        {% if request.args.get('location') == loc.get('Location Name') %}selected{% endif %}>
                                    {{ loc.get('Location Name', '') }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" onchange="this.form.submit()">
                                <option value="">All Status</option>
                                <option value="Active" {% if request.args.get('status') == 'Active' %}selected{% endif %}>Active</option>
                                <option value="Inactive" {% if request.args.get('status') == 'Inactive' %}selected{% endif %}>Inactive</option>
                                <option value="Under Maintenance" {% if request.args.get('status') == 'Under Maintenance' %}selected{% endif %}>Under Maintenance</option>
                                <option value="Disposed" {% if request.args.get('status') == 'Disposed' %}selected{% endif %}>Disposed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <a href="{{ url_for('depreciation') }}" class="btn btn-secondary w-100">
                                    <i class="bi bi-x-circle"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Depreciation Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Asset Depreciation Details</h5>
                <span class="badge bg-secondary">{{ filtered_assets|length }} assets</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Asset Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Location</th>
                                <th>Purchase Date</th>
                                <th>Age (Years)</th>
                                <th>Purchase Amount</th>
                                <th>Depreciation %</th>
                                <th>Annual Depreciation</th>
                                <th>Total Depreciation</th>
                                <th>Current Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in filtered_assets %}
                            <tr>
                                <td><strong>{{ asset.get('Asset Code', '') }}</strong></td>
                                <td>{{ asset.get('Item Name', '') }}</td>
                                <td>{{ asset.get('Asset Category', '') }}</td>
                                <td>{{ asset.get('Location', '') }}</td>
                                <td>{{ asset.get('Date of Purchase', '') or '-' }}</td>
                                <td>
                                    {% if asset.get('age_years') %}
                                        <span class="badge bg-info">{{ "%.1f"|format(asset.get('age_years', 0)) }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if asset.get('purchase_amount') %}
                                        ${{ "{:,.2f}".format(asset.get('purchase_amount', 0)) }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if asset.get('depreciation_percent') %}
                                        <span class="badge bg-secondary">{{ asset.get('depreciation_percent', 0) }}%</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if asset.get('annual_depreciation') %}
                                        <strong class="text-warning">${{ "{:,.2f}".format(asset.get('annual_depreciation', 0)) }}</strong>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if asset.get('total_depreciation') %}
                                        <strong class="text-danger">${{ "{:,.2f}".format(asset.get('total_depreciation', 0)) }}</strong>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if asset.get('current_value') is not none %}
                                        <strong class="text-success">${{ "{:,.2f}".format(asset.get('current_value', 0)) }}</strong>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set status = asset.get('Asset Status', '') %}
                                    {% if status == 'Active' %}
                                        <span class="badge bg-success">{{ status }}</span>
                                    {% elif status == 'Inactive' %}
                                        <span class="badge bg-secondary">{{ status }}</span>
                                    {% elif status == 'Under Maintenance' %}
                                        <span class="badge bg-warning text-dark">{{ status }}</span>
                                    {% elif status == 'Disposed' %}
                                        <span class="badge bg-danger">{{ status }}</span>
                                    {% elif status == 'Sold' %}
                                        <span class="badge bg-info">{{ status }}</span>
                                    {% elif status == 'Lost' %}
                                        <span class="badge bg-dark">{{ status }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="12" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                    <p class="mt-2">No assets found matching the filters</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f7fafc; font-weight: 600;">
                                <td colspan="6" class="text-end"><strong>Totals:</strong></td>
                                <td><strong>${{ "{:,.2f}".format(filtered_purchase_value) }}</strong></td>
                                <td></td>
                                <td><strong>${{ "{:,.2f}".format(filtered_annual_depreciation) }}</strong></td>
                                <td><strong class="text-danger">${{ "{:,.2f}".format(filtered_total_depreciation) }}</strong></td>
                                <td><strong class="text-success">${{ "{:,.2f}".format(filtered_current_value) }}</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Calculation Method Info -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Depreciation Calculation Method</h5>
            </div>
            <div class="card-body">
                <p><strong>Straight-Line Depreciation Method:</strong></p>
                <ul>
                    <li>Annual Depreciation = (Purchase Amount × Depreciation %) / 100</li>
                    <li>Total Depreciation = Annual Depreciation × Age in Years</li>
                    <li>Current Book Value = Purchase Amount - Total Depreciation</li>
                    <li>Age in Years = (Current Date - Purchase Date) / 365.25</li>
                </ul>
                <p class="text-muted mb-0"><small><i class="bi bi-exclamation-circle"></i> Note: Assets without purchase date or amount, or without matching asset type depreciation rate, cannot be calculated.</small></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

